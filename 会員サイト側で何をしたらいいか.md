# ä¼šå“¡ã‚µã‚¤ãƒˆå´å®Ÿè£…ã‚¬ã‚¤ãƒ‰

## ğŸ“‹ æ¦‚è¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€Adminãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§å®Ÿè£…ã•ã‚ŒãŸä¼šå“¡ã‚µã‚¤ãƒˆç®¡ç†æ©Ÿèƒ½ã«å¯¾å¿œã™ã‚‹ãŸã‚ã€ä¼šå“¡ã‚µã‚¤ãƒˆå´ã§å®Ÿè£…ã™ã¹ãæ©Ÿèƒ½ã‚’ã¾ã¨ã‚ãŸã‚‚ã®ã§ã™ã€‚

---

## ğŸ¯ å®Ÿè£…ãŒå¿…è¦ãªæ©Ÿèƒ½ä¸€è¦§

### 1. ãƒ—ãƒ©ãƒ³éšå±¤åˆ¥ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
### 2. é€šçŸ¥æ©Ÿèƒ½ï¼ˆãŠçŸ¥ã‚‰ã›è¡¨ç¤ºï¼‰
### 3. ãƒ–ãƒ­ã‚°/ã‚¬ã‚¤ãƒ‰æ©Ÿèƒ½ï¼ˆæŠ•ç¨¿è¡¨ç¤ºï¼‰
### 4. Stripeæ±ºæ¸ˆè¨­å®šãƒšãƒ¼ã‚¸
### 5. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤º

---

## 1. ãƒ—ãƒ©ãƒ³éšå±¤åˆ¥ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

### æ¦‚è¦

Adminãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§è¨­å®šã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ©ãƒ³éšå±¤ï¼ˆæ¢…ãƒ»ç«¹ãƒ»æ¾ï¼‰ã«åŸºã¥ã„ã¦ã€ä¼šå“¡ã‚µã‚¤ãƒˆå´ã§ã®æ©Ÿèƒ½ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚

### ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

**Firestore `users` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:**
```typescript
interface User {
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  
  /**
   * ãƒ—ãƒ©ãƒ³éšå±¤
   * - "ume": æ¢…ãƒ—ãƒ©ãƒ³ï¼ˆæŠ•ç¨¿ãƒ©ãƒœã®ã¿ï¼‰
   * - "take": ç«¹ãƒ—ãƒ©ãƒ³ï¼ˆæŠ•ç¨¿ãƒ©ãƒœ + æŠ•ç¨¿ä¸€è¦§ï¼‰
   * - "matsu": æ¾ãƒ—ãƒ©ãƒ³ï¼ˆå…¨æ©Ÿèƒ½ï¼‰
   * 
   * ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤: "ume" ï¼ˆæ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ¢…ãƒ—ãƒ©ãƒ³ã§é–‹å§‹ï¼‰
   */
  planTier?: 'ume' | 'take' | 'matsu'
}
```

### å®Ÿè£…æ‰‹é †

#### 1-1. å‹å®šç¾©ã®è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«: `src/types/user.ts`**

```typescript
export interface UserProfile {
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  planTier?: 'ume' | 'take' | 'matsu'
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
}

export type PlanTier = 'ume' | 'take' | 'matsu'
```

#### 1-2. ãƒ—ãƒ©ãƒ³ãƒã‚§ãƒƒã‚¯ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«: `src/lib/plan-access.ts`** ï¼ˆæ–°è¦ä½œæˆï¼‰

```typescript
import { UserProfile } from '@/types/user'

export type PlanTier = 'ume' | 'take' | 'matsu'

export const PLAN_FEATURES = {
  ume: {
    canAccessLab: true,
    canAccessPosts: false,
    canAccessAnalytics: false,
    canAccessPlan: false,
    canAccessReport: false,
    canAccessKPI: false,
    canAccessLearning: false,
  },
  take: {
    canAccessLab: true,
    canAccessPosts: true,
    canAccessAnalytics: false,
    canAccessPlan: false,
    canAccessReport: false,
    canAccessKPI: false,
    canAccessLearning: false,
  },
  matsu: {
    canAccessLab: true,
    canAccessPosts: true,
    canAccessAnalytics: true,
    canAccessPlan: true,
    canAccessReport: true,
    canAccessKPI: true,
    canAccessLearning: true,
  },
} as const

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ©ãƒ³éšå±¤ã‚’å–å¾—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯"ume"ï¼‰
 */
export function getUserPlanTier(userProfile: UserProfile | null | undefined): PlanTier {
  return userProfile?.planTier || 'ume'
}

/**
 * ç‰¹å®šæ©Ÿèƒ½ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯
 */
export function canAccessFeature(
  userProfile: UserProfile | null | undefined,
  feature: keyof typeof PLAN_FEATURES.ume
): boolean {
  const tier = getUserPlanTier(userProfile)
  return PLAN_FEATURES[tier][feature]
}

/**
 * ãƒ—ãƒ©ãƒ³éšå±¤ã«åŸºã¥ã„ã¦ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
 */
export function getAccessDeniedMessage(feature: string): string {
  return `${feature}æ©Ÿèƒ½ã¯ã€ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ã§ã¯ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã›ã‚“ã€‚ãƒ—ãƒ©ãƒ³ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚’ã”æ¤œè¨ãã ã•ã„ã€‚`
}

/**
 * ãƒ—ãƒ©ãƒ³ã®è¡¨ç¤ºåã‚’å–å¾—
 */
export function getPlanName(tier: PlanTier): string {
  const names = {
    ume: 'æ¢…ãƒ—ãƒ©ãƒ³',
    take: 'ç«¹ãƒ—ãƒ©ãƒ³',
    matsu: 'æ¾ãƒ—ãƒ©ãƒ³',
  }
  return names[tier]
}
```

#### 1-3. ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã®åˆ¶å¾¡

**ãƒ•ã‚¡ã‚¤ãƒ«: `src/app/instagram/posts/page.tsx`**ï¼ˆä¾‹ï¼‰

```typescript
'use client'

import { useUserProfile } from '@/hooks/useUserProfile'
import { canAccessFeature, getAccessDeniedMessage } from '@/lib/plan-access'
import { useRouter } from 'next/navigation'
import { useEffect } from 'react'

export default function PostsPage() {
  const { userProfile, loading } = useUserProfile()
  const router = useRouter()

  useEffect(() => {
    if (!loading && !canAccessFeature(userProfile, 'canAccessPosts')) {
      router.push('/home')
      // ã¾ãŸã¯å°‚ç”¨ã®ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    }
  }, [userProfile, loading, router])

  if (loading) {
    return <div>èª­ã¿è¾¼ã¿ä¸­...</div>
  }

  if (!canAccessFeature(userProfile, 'canAccessPosts')) {
    return (
      <div className="p-8 text-center">
        <h2 className="text-xl font-bold mb-4">æ©Ÿèƒ½ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™</h2>
        <p>{getAccessDeniedMessage('æŠ•ç¨¿ä¸€è¦§')}</p>
        {/* ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰èª˜å°ãƒœã‚¿ãƒ³ãªã© */}
      </div>
    )
  }

  // ... é€šå¸¸ã®ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
}
```

#### 1-4. ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆ¶å¾¡

**ãƒ•ã‚¡ã‚¤ãƒ«: `src/components/sns-layout.tsx`**

```typescript
import { canAccessFeature } from '@/lib/plan-access'

// ã‚µã‚¤ãƒ‰ãƒãƒ¼å†…ã§æ¡ä»¶ä»˜ããƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
{canAccessFeature(userProfile, 'canAccessPosts') && (
  <Link href="/instagram/posts">æŠ•ç¨¿ä¸€è¦§</Link>
)}

{canAccessFeature(userProfile, 'canAccessAnalytics') && (
  <Link href="/instagram/analytics/feed">æŠ•ç¨¿åˆ†æ</Link>
)}
```

#### 1-5. APIãƒ«ãƒ¼ãƒˆã§ã®åˆ¶å¾¡

**ãƒ•ã‚¡ã‚¤ãƒ«: `src/app/api/posts/route.ts`**

```typescript
import { requireAuthContext } from '@/lib/server/auth-context'
import { getUserProfile } from '@/lib/server/user-profile'
import { canAccessFeature } from '@/lib/plan-access'
import { ForbiddenError } from '@/lib/server/errors'

export async function GET(request: NextRequest) {
  const authContext = await requireAuthContext(request, {
    requireContract: true,
  })

  const userProfile = await getUserProfile(authContext.uid)

  // ãƒ—ãƒ©ãƒ³ãƒã‚§ãƒƒã‚¯
  if (!canAccessFeature(userProfile, 'canAccessPosts')) {
    throw new ForbiddenError(
      'æŠ•ç¨¿ä¸€è¦§æ©Ÿèƒ½ã¯ã€ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ã§ã¯ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã›ã‚“ã€‚'
    )
  }

  // ... é€šå¸¸ã®APIå‡¦ç†
}
```

### ãƒšãƒ¼ã‚¸ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°åˆ¶å¾¡ãƒãƒˆãƒªãƒƒã‚¯ã‚¹

| ãƒšãƒ¼ã‚¸ãƒ‘ã‚¹ | æ¢…ãƒ—ãƒ©ãƒ³ | ç«¹ãƒ—ãƒ©ãƒ³ | æ¾ãƒ—ãƒ©ãƒ³ |
|-----------|---------|---------|---------|
| `/instagram/lab/*` | âœ… | âœ… | âœ… |
| `/instagram/posts` | âŒ | âœ… | âœ… |
| `/instagram/posts/[id]` | âŒ | âœ… | âœ… |
| `/instagram/analytics/*` | âŒ | âŒ | âœ… |
| `/instagram/plan` | âŒ | âŒ | âœ… |
| `/instagram/report` | âŒ | âŒ | âœ… |
| `/instagram/kpi` | âŒ | âŒ | âœ… |
| `/learning` | âŒ | âŒ | âœ… |
| `/home` | âœ… | âœ… | âœ… |

---

## 2. é€šçŸ¥æ©Ÿèƒ½ï¼ˆãŠçŸ¥ã‚‰ã›è¡¨ç¤ºï¼‰

### æ¦‚è¦

Adminãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½œæˆãƒ»å…¬é–‹ã•ã‚ŒãŸãŠçŸ¥ã‚‰ã›ã‚’ä¼šå“¡ã‚µã‚¤ãƒˆå´ã§è¡¨ç¤ºã—ã¾ã™ã€‚

### ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

**Firestore `notifications` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³:**
```typescript
interface Notification {
  id: string
  title: string
  content: string
  type: 'info' | 'warning' | 'error' | 'success' | 'maintenance'
  priority: 'low' | 'medium' | 'high' | 'urgent'
  status: 'draft' | 'published' | 'archived'
  targetAudience: 'all' | 'trial' | 'paid' | 'admin'
  scheduledAt?: string
  publishedAt?: string
  expiresAt?: string
  createdBy: string
  createdAt: string
  updatedAt: string
  tags: string[]
  isSticky: boolean // å›ºå®šè¡¨ç¤ºï¼ˆå¸¸ã«ä¸Šéƒ¨ã«è¡¨ç¤ºï¼‰
  readCount: number
  clickCount: number
}
```

### å®Ÿè£…æ‰‹é †

#### 2-1. å‹å®šç¾©ã®è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«: `src/types/notification.ts`** ï¼ˆæ–°è¦ä½œæˆï¼‰

```typescript
export interface Notification {
  id: string
  title: string
  content: string
  type: 'info' | 'warning' | 'error' | 'success' | 'maintenance'
  priority: 'low' | 'medium' | 'high' | 'urgent'
  status: 'draft' | 'published' | 'archived'
  targetAudience: 'all' | 'trial' | 'paid' | 'admin'
  scheduledAt?: string
  publishedAt?: string
  expiresAt?: string
  createdBy: string
  createdAt: string
  updatedAt: string
  tags: string[]
  isSticky: boolean
  readCount: number
  clickCount: number
}
```

#### 2-2. é€šçŸ¥å–å¾—ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«: `src/lib/notifications.ts`** ï¼ˆæ–°è¦ä½œæˆï¼‰

```typescript
import { 
  collection, 
  query, 
  where, 
  orderBy, 
  getDocs,
  Timestamp,
  limit
} from 'firebase/firestore'
import { db } from './firebase'
import { Notification } from '@/types/notification'

/**
 * å…¬é–‹ä¸­ã®ãŠçŸ¥ã‚‰ã›ã‚’å–å¾—ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ï¼‰
 * @param targetAudience å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆ'all' | 'trial' | 'paid'ï¼‰
 * @param userId ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆæœªèª­ãƒã‚§ãƒƒã‚¯ç”¨ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
 */
export async function getPublishedNotifications(
  targetAudience: 'all' | 'trial' | 'paid' = 'all',
  userId?: string
): Promise<Notification[]> {
  try {
    const now = Timestamp.now()
    
    // åŸºæœ¬ã‚¯ã‚¨ãƒª: status === 'published'
    let q = query(
      collection(db, 'notifications'),
      where('status', '==', 'published'),
      orderBy('isSticky', 'desc'), // å›ºå®šè¡¨ç¤ºã‚’å…ˆã«
      orderBy('publishedAt', 'desc'),
      limit(50)
    )

    // targetAudienceãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆ'all'ã®å ´åˆã¯å…¨ã¦è¡¨ç¤ºï¼‰
    if (targetAudience !== 'all') {
      q = query(
        collection(db, 'notifications'),
        where('status', '==', 'published'),
        where('targetAudience', 'in', ['all', targetAudience]), // 'all'ã¾ãŸã¯å¯¾è±¡ã‚°ãƒ«ãƒ¼ãƒ—
        orderBy('isSticky', 'desc'),
        orderBy('publishedAt', 'desc'),
        limit(50)
      )
    }

    const snapshot = await getDocs(q)
    
    const notifications = snapshot.docs
      .map(doc => ({
        id: doc.id,
        ...doc.data(),
        createdAt: doc.data().createdAt?.toDate?.()?.toISOString() || doc.data().createdAt,
        updatedAt: doc.data().updatedAt?.toDate?.()?.toISOString() || doc.data().updatedAt,
        publishedAt: doc.data().publishedAt?.toDate?.()?.toISOString() || doc.data().publishedAt,
        expiresAt: doc.data().expiresAt?.toDate?.()?.toISOString() || doc.data().expiresAt,
        scheduledAt: doc.data().scheduledAt?.toDate?.()?.toISOString() || doc.data().scheduledAt,
      })) as Notification[]

    // æœŸé™åˆ‡ã‚Œã®ãŠçŸ¥ã‚‰ã›ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const validNotifications = notifications.filter(notification => {
      if (!notification.expiresAt) return true
      const expiresDate = new Date(notification.expiresAt)
      return expiresDate > new Date()
    })

    // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ¸ˆã¿ã®ãŠçŸ¥ã‚‰ã›ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const activeNotifications = validNotifications.filter(notification => {
      if (!notification.scheduledAt) return true
      const scheduledDate = new Date(notification.scheduledAt)
      return scheduledDate <= new Date()
    })

    return activeNotifications
  } catch (error) {
    console.error('Error fetching notifications:', error)
    throw error
  }
}

/**
 * é€šçŸ¥ã®é–²è¦§æ•°ã‚’æ›´æ–°
 */
export async function markNotificationAsRead(
  notificationId: string,
  userId: string
): Promise<void> {
  try {
    const notificationRef = doc(db, 'notifications', notificationId)
    await updateDoc(notificationRef, {
      readCount: increment(1),
      // å¿…è¦ã«å¿œã˜ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã®èª­ã¿å–ã‚Šå±¥æ­´ã‚’ä¿å­˜
      // readBy: arrayUnion(userId)
    })
  } catch (error) {
    console.error('Error marking notification as read:', error)
    // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆèª­ã¿å–ã‚Šæ•°ã®æ›´æ–°ã¯é‡è¦ã§ã¯ãªã„ï¼‰
  }
}
```

#### 2-3. é€šçŸ¥ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«: `src/components/notifications/notification-banner.tsx`** ï¼ˆæ–°è¦ä½œæˆï¼‰

```typescript
'use client'

import React, { useState, useEffect } from 'react'
import { X, AlertCircle, CheckCircle, AlertTriangle, Info, Wrench } from 'lucide-react'
import { Notification } from '@/types/notification'
import { getPublishedNotifications, markNotificationAsRead } from '@/lib/notifications'
import { useUserProfile } from '@/hooks/useUserProfile'
import { getUserPlanTier } from '@/lib/plan-access'

const typeIcons = {
  info: Info,
  success: CheckCircle,
  warning: AlertTriangle,
  error: AlertCircle,
  maintenance: Wrench,
}

const typeColors = {
  info: 'bg-blue-50 border-blue-200 text-blue-800',
  success: 'bg-green-50 border-green-200 text-green-800',
  warning: 'bg-yellow-50 border-yellow-200 text-yellow-800',
  error: 'bg-red-50 border-red-200 text-red-800',
  maintenance: 'bg-gray-50 border-gray-200 text-gray-800',
}

export function NotificationBanner() {
  const { userProfile } = useUserProfile()
  const [notifications, setNotifications] = useState<Notification[]>([])
  const [dismissedIds, setDismissedIds] = useState<Set<string>>(new Set())
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    const fetchNotifications = async () => {
      try {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ©ãƒ³éšå±¤ã«åŸºã¥ã„ã¦targetAudienceã‚’æ±ºå®š
        const planTier = getUserPlanTier(userProfile)
        const targetAudience = planTier === 'ume' ? 'trial' : 'paid' // ä¾‹: æ¢…ãƒ—ãƒ©ãƒ³ã¯'trial'ã€ãã‚Œä»¥å¤–ã¯'paid'
        
        const publishedNotifications = await getPublishedNotifications(targetAudience)
        setNotifications(publishedNotifications)
      } catch (error) {
        console.error('Error fetching notifications:', error)
      } finally {
        setLoading(false)
      }
    }

    if (userProfile) {
      fetchNotifications()
    }
  }, [userProfile])

  const handleDismiss = (notificationId: string) => {
    setDismissedIds(prev => new Set([...prev, notificationId]))
    // localStorageã«ä¿å­˜ã—ã¦æ°¸ç¶šåŒ–
    if (typeof window !== 'undefined') {
      const dismissed = JSON.parse(localStorage.getItem('dismissedNotifications') || '[]')
      dismissed.push(notificationId)
      localStorage.setItem('dismissedNotifications', JSON.stringify(dismissed))
    }
  }

  const handleClick = async (notification: Notification) => {
    if (userProfile?.id) {
      await markNotificationAsRead(notification.id, userProfile.id)
    }
  }

  // å›ºå®šè¡¨ç¤ºã®ãŠçŸ¥ã‚‰ã›ã¨é€šå¸¸ã®ãŠçŸ¥ã‚‰ã›ã‚’åˆ†ã‘ã‚‹
  const stickyNotifications = notifications.filter(n => n.isSticky && !dismissedIds.has(n.id))
  const regularNotifications = notifications
    .filter(n => !n.isSticky && !dismissedIds.has(n.id))
    .slice(0, 3) // æœ€å¤§3ä»¶ã¾ã§è¡¨ç¤º

  if (loading || (stickyNotifications.length === 0 && regularNotifications.length === 0)) {
    return null
  }

  return (
    <div className="fixed top-0 left-0 right-0 z-50 space-y-2 p-4">
      {/* å›ºå®šè¡¨ç¤ºã®ãŠçŸ¥ã‚‰ã› */}
      {stickyNotifications.map(notification => {
        const Icon = typeIcons[notification.type]
        return (
          <div
            key={notification.id}
            className={`border rounded-lg p-4 shadow-lg ${typeColors[notification.type]}`}
          >
            <div className="flex items-start gap-3">
              <Icon className="h-5 w-5 flex-shrink-0 mt-0.5" />
              <div className="flex-1 min-w-0">
                <h3 className="font-semibold text-sm mb-1">{notification.title}</h3>
                <p className="text-sm whitespace-pre-wrap">{notification.content}</p>
                {notification.tags.length > 0 && (
                  <div className="flex gap-1 mt-2">
                    {notification.tags.map(tag => (
                      <span
                        key={tag}
                        className="px-2 py-0.5 bg-white/50 rounded text-xs"
                      >
                        {tag}
                      </span>
                    ))}
                  </div>
                )}
              </div>
              <button
                onClick={() => handleDismiss(notification.id)}
                className="flex-shrink-0 text-current opacity-70 hover:opacity-100"
              >
                <X className="h-4 w-4" />
              </button>
            </div>
          </div>
        )
      })}

      {/* é€šå¸¸ã®ãŠçŸ¥ã‚‰ã› */}
      {regularNotifications.map(notification => {
        const Icon = typeIcons[notification.type]
        return (
          <div
            key={notification.id}
            onClick={() => handleClick(notification)}
            className={`border rounded-lg p-3 shadow-md cursor-pointer transition-all hover:shadow-lg ${typeColors[notification.type]}`}
          >
            <div className="flex items-start gap-2">
              <Icon className="h-4 w-4 flex-shrink-0 mt-0.5" />
              <div className="flex-1 min-w-0">
                <h3 className="font-medium text-sm">{notification.title}</h3>
              </div>
              <button
                onClick={(e) => {
                  e.stopPropagation()
                  handleDismiss(notification.id)
                }}
                className="flex-shrink-0 text-current opacity-70 hover:opacity-100"
              >
                <X className="h-3 w-3" />
              </button>
            </div>
          </div>
        )
      })}
    </div>
  )
}
```

#### 2-4. é€šçŸ¥ä¸€è¦§ãƒšãƒ¼ã‚¸ã®ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«: `src/app/notifications/page.tsx`** ï¼ˆæ–°è¦ä½œæˆï¼‰

```typescript
'use client'

import React, { useState, useEffect } from 'react'
import { NotificationBanner } from '@/components/notifications/notification-banner'
import { getPublishedNotifications } from '@/lib/notifications'
import { Notification } from '@/types/notification'
import { useUserProfile } from '@/hooks/useUserProfile'
import { getUserPlanTier } from '@/lib/plan-access'

export default function NotificationsPage() {
  const { userProfile } = useUserProfile()
  const [notifications, setNotifications] = useState<Notification[]>([])
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    const fetchNotifications = async () => {
      try {
        const planTier = getUserPlanTier(userProfile)
        const targetAudience = planTier === 'ume' ? 'trial' : 'paid'
        
        const publishedNotifications = await getPublishedNotifications(targetAudience)
        setNotifications(publishedNotifications)
      } catch (error) {
        console.error('Error fetching notifications:', error)
      } finally {
        setLoading(false)
      }
    }

    if (userProfile) {
      fetchNotifications()
    }
  }, [userProfile])

  if (loading) {
    return <div>èª­ã¿è¾¼ã¿ä¸­...</div>
  }

  return (
    <div className="container mx-auto py-8">
      <h1 className="text-2xl font-bold mb-6">ãŠçŸ¥ã‚‰ã›</h1>
      
      {notifications.length === 0 ? (
        <p className="text-muted-foreground">ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“</p>
      ) : (
        <div className="space-y-4">
          {notifications.map(notification => (
            <div
              key={notification.id}
              className="border rounded-lg p-6 shadow-sm"
            >
              <h2 className="text-xl font-semibold mb-2">{notification.title}</h2>
              <div className="text-sm text-muted-foreground mb-4">
                {new Date(notification.publishedAt || notification.createdAt).toLocaleDateString('ja-JP')}
              </div>
              <div className="whitespace-pre-wrap">{notification.content}</div>
              {notification.tags.length > 0 && (
                <div className="flex gap-2 mt-4">
                  {notification.tags.map(tag => (
                    <span
                      key={tag}
                      className="px-2 py-1 bg-muted rounded text-xs"
                    >
                      {tag}
                    </span>
                  ))}
                </div>
              )}
            </div>
          ))}
        </div>
      )}
    </div>
  )
}
```

#### 2-5. ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«é€šçŸ¥ãƒãƒŠãƒ¼ã‚’è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«: `src/app/layout.tsx`**

```typescript
import { NotificationBanner } from '@/components/notifications/notification-banner'

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja">
      <body>
        <NotificationBanner />
        {children}
      </body>
    </html>
  )
}
```

---

## 3. ãƒ–ãƒ­ã‚°/ã‚¬ã‚¤ãƒ‰æ©Ÿèƒ½ï¼ˆæŠ•ç¨¿è¡¨ç¤ºï¼‰

### æ¦‚è¦

Adminãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½œæˆãƒ»å…¬é–‹ã•ã‚ŒãŸãƒ–ãƒ­ã‚°è¨˜äº‹ï¼ˆã‚¬ã‚¤ãƒ‰ï¼‰ã‚’ä¼šå“¡ã‚µã‚¤ãƒˆå´ã§è¡¨ç¤ºã—ã¾ã™ã€‚

### ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

**Firestore `blogPosts` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³:**
```typescript
interface BlogPost {
  id: string
  title: string
  slug: string // URLç”¨ã®ã‚¹ãƒ©ãƒƒã‚°
  excerpt: string // æŠœç²‹æ–‡
  content: string // æœ¬æ–‡ï¼ˆMarkdownå¯¾å¿œï¼‰
  featuredImage?: string // ãƒ¡ã‚¤ãƒ³ç”»åƒ
  images: string[] // æœ¬æ–‡å†…ç”»åƒ
  category: string // ã‚«ãƒ†ã‚´ãƒª
  tags: string[] // ã‚¿ã‚°
  status: 'draft' | 'published' | 'archived'
  publishedAt?: string // å…¬é–‹æ—¥æ™‚
  createdAt: string
  updatedAt: string
  author: string // ä½œæˆè€…
  viewCount: number
  seoTitle?: string
  seoDescription?: string
  readingTime?: number // èª­äº†æ™‚é–“ï¼ˆåˆ†ï¼‰
}
```

### å®Ÿè£…æ‰‹é †

#### 3-1. å‹å®šç¾©ã®è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«: `src/types/blog.ts`** ï¼ˆæ–°è¦ä½œæˆï¼‰

```typescript
export interface BlogPost {
  id: string
  title: string
  slug: string
  excerpt: string
  content: string
  featuredImage?: string
  images: string[]
  category: string
  tags: string[]
  status: 'draft' | 'published' | 'archived'
  publishedAt?: string
  createdAt: string
  updatedAt: string
  author: string
  viewCount: number
  seoTitle?: string
  seoDescription?: string
  readingTime?: number
}

export interface BlogCategory {
  id: string
  name: string
  slug: string
  description?: string
  color: string
  postCount: number
}

export interface BlogTag {
  id: string
  name: string
  slug: string
  color?: string
  postCount: number
}
```

#### 3-2. ãƒ–ãƒ­ã‚°å–å¾—ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«: `src/lib/blog.ts`** ï¼ˆæ–°è¦ä½œæˆï¼‰

```typescript
import { 
  collection, 
  query, 
  where, 
  orderBy, 
  getDocs,
  getDoc,
  doc,
  updateDoc,
  increment,
  Timestamp,
  limit
} from 'firebase/firestore'
import { db } from './firebase'
import { BlogPost } from '@/types/blog'

/**
 * å…¬é–‹ä¸­ã®ãƒ–ãƒ­ã‚°è¨˜äº‹ä¸€è¦§ã‚’å–å¾—
 * @param category ã‚«ãƒ†ã‚´ãƒªã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
 * @param tag ã‚¿ã‚°ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
 * @param limit å–å¾—ä»¶æ•°
 */
export async function getPublishedBlogPosts(
  category?: string,
  tag?: string,
  limitCount: number = 20
): Promise<BlogPost[]> {
  try {
    let q = query(
      collection(db, 'blogPosts'),
      where('status', '==', 'published'),
      orderBy('publishedAt', 'desc'),
      limit(limitCount)
    )

    if (category) {
      q = query(
        collection(db, 'blogPosts'),
        where('status', '==', 'published'),
        where('category', '==', category),
        orderBy('publishedAt', 'desc'),
        limit(limitCount)
      )
    }

    if (tag) {
      q = query(
        collection(db, 'blogPosts'),
        where('status', '==', 'published'),
        where('tags', 'array-contains', tag),
        orderBy('publishedAt', 'desc'),
        limit(limitCount)
      )
    }

    const snapshot = await getDocs(q)
    
    return snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data(),
      publishedAt: doc.data().publishedAt?.toDate?.()?.toISOString() || doc.data().publishedAt,
      createdAt: doc.data().createdAt?.toDate?.()?.toISOString() || doc.data().createdAt,
      updatedAt: doc.data().updatedAt?.toDate?.()?.toISOString() || doc.data().updatedAt,
    })) as BlogPost[]
  } catch (error) {
    console.error('Error fetching blog posts:', error)
    throw error
  }
}

/**
 * ã‚¹ãƒ©ãƒƒã‚°ã‹ã‚‰ãƒ–ãƒ­ã‚°è¨˜äº‹ã‚’å–å¾—
 */
export async function getBlogPostBySlug(slug: string): Promise<BlogPost | null> {
  try {
    const q = query(
      collection(db, 'blogPosts'),
      where('status', '==', 'published'),
      where('slug', '==', slug),
      limit(1)
    )

    const snapshot = await getDocs(q)
    
    if (snapshot.empty) {
      return null
    }

    const docData = snapshot.docs[0].data()
    return {
      id: snapshot.docs[0].id,
      ...docData,
      publishedAt: docData.publishedAt?.toDate?.()?.toISOString() || docData.publishedAt,
      createdAt: docData.createdAt?.toDate?.()?.toISOString() || docData.createdAt,
      updatedAt: docData.updatedAt?.toDate?.()?.toISOString() || docData.updatedAt,
    } as BlogPost
  } catch (error) {
    console.error('Error fetching blog post by slug:', error)
    throw error
  }
}

/**
 * é–²è¦§æ•°ã‚’æ›´æ–°
 */
export async function incrementBlogPostViewCount(postId: string): Promise<void> {
  try {
    const postRef = doc(db, 'blogPosts', postId)
    await updateDoc(postRef, {
      viewCount: increment(1),
    })
  } catch (error) {
    console.error('Error incrementing view count:', error)
    // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
  }
}
```

#### 3-3. ãƒ–ãƒ­ã‚°ä¸€è¦§ãƒšãƒ¼ã‚¸ã®ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«: `src/app/guides/page.tsx`** ï¼ˆæ–°è¦ä½œæˆï¼‰

```typescript
'use client'

import React, { useState, useEffect } from 'react'
import Link from 'next/link'
import { getPublishedBlogPosts } from '@/lib/blog'
import { BlogPost } from '@/types/blog'
import { Calendar, Clock } from 'lucide-react'

export default function GuidesPage() {
  const [posts, setPosts] = useState<BlogPost[]>([])
  const [loading, setLoading] = useState(true)
  const [selectedCategory, setSelectedCategory] = useState<string>('all')

  useEffect(() => {
    const fetchPosts = async () => {
      try {
        const category = selectedCategory === 'all' ? undefined : selectedCategory
        const publishedPosts = await getPublishedBlogPosts(category)
        setPosts(publishedPosts)
      } catch (error) {
        console.error('Error fetching blog posts:', error)
      } finally {
        setLoading(false)
      }
    }

    fetchPosts()
  }, [selectedCategory])

  if (loading) {
    return <div>èª­ã¿è¾¼ã¿ä¸­...</div>
  }

  return (
    <div className="container mx-auto py-8">
      <h1 className="text-3xl font-bold mb-8">ã‚¬ã‚¤ãƒ‰ãƒ»ãƒ˜ãƒ«ãƒ—</h1>
      
      {/* ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
      <div className="flex gap-2 mb-8">
        <button
          onClick={() => setSelectedCategory('all')}
          className={`px-4 py-2 rounded ${selectedCategory === 'all' ? 'bg-primary text-primary-foreground' : 'bg-muted'}`}
        >
          ã™ã¹ã¦
        </button>
        {/* ã‚«ãƒ†ã‚´ãƒªã¯å‹•çš„ã«å–å¾—ã™ã‚‹ã‹ã€å›ºå®šå€¤ã‚’è¨­å®š */}
      </div>

      {/* è¨˜äº‹ä¸€è¦§ */}
      {posts.length === 0 ? (
        <p className="text-muted-foreground">è¨˜äº‹ã¯ã‚ã‚Šã¾ã›ã‚“</p>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {posts.map(post => (
            <Link
              key={post.id}
              href={`/guides/${post.slug}`}
              className="border rounded-lg overflow-hidden hover:shadow-lg transition-shadow"
            >
              {post.featuredImage && (
                <img
                  src={post.featuredImage}
                  alt={post.title}
                  className="w-full h-48 object-cover"
                />
              )}
              <div className="p-6">
                <div className="text-sm text-muted-foreground mb-2">
                  {post.category}
                </div>
                <h2 className="text-xl font-semibold mb-2">{post.title}</h2>
                <p className="text-muted-foreground text-sm mb-4 line-clamp-3">
                  {post.excerpt}
                </p>
                <div className="flex items-center gap-4 text-xs text-muted-foreground">
                  {post.publishedAt && (
                    <div className="flex items-center gap-1">
                      <Calendar className="h-3 w-3" />
                      {new Date(post.publishedAt).toLocaleDateString('ja-JP')}
                    </div>
                  )}
                  {post.readingTime && (
                    <div className="flex items-center gap-1">
                      <Clock className="h-3 w-3" />
                      {post.readingTime}åˆ†
                    </div>
                  )}
                </div>
              </div>
            </Link>
          ))}
        </div>
      )}
    </div>
  )
}
```

#### 3-4. ãƒ–ãƒ­ã‚°è©³ç´°ãƒšãƒ¼ã‚¸ã®ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«: `src/app/guides/[slug]/page.tsx`** ï¼ˆæ–°è¦ä½œæˆï¼‰

```typescript
'use client'

import React, { useEffect, useState } from 'react'
import { useParams } from 'next/navigation'
import { getBlogPostBySlug, incrementBlogPostViewCount } from '@/lib/blog'
import { BlogPost } from '@/types/blog'
import { Calendar, Clock, Eye } from 'lucide-react'
import ReactMarkdown from 'react-markdown' // å¿…è¦ã«å¿œã˜ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

export default function BlogPostPage() {
  const params = useParams()
  const slug = params.slug as string
  const [post, setPost] = useState<BlogPost | null>(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    const fetchPost = async () => {
      try {
        const blogPost = await getBlogPostBySlug(slug)
        setPost(blogPost)
        
        // é–²è¦§æ•°ã‚’æ›´æ–°
        if (blogPost) {
          await incrementBlogPostViewCount(blogPost.id)
        }
      } catch (error) {
        console.error('Error fetching blog post:', error)
      } finally {
        setLoading(false)
      }
    }

    if (slug) {
      fetchPost()
    }
  }, [slug])

  if (loading) {
    return <div>èª­ã¿è¾¼ã¿ä¸­...</div>
  }

  if (!post) {
    return <div>è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>
  }

  return (
    <div className="container mx-auto py-8 max-w-4xl">
      {/* ãƒ¡ã‚¿æƒ…å ± */}
      <div className="mb-6">
        <div className="text-sm text-muted-foreground mb-2">{post.category}</div>
        <h1 className="text-4xl font-bold mb-4">{post.title}</h1>
        <div className="flex items-center gap-4 text-sm text-muted-foreground">
          {post.publishedAt && (
            <div className="flex items-center gap-1">
              <Calendar className="h-4 w-4" />
              {new Date(post.publishedAt).toLocaleDateString('ja-JP')}
            </div>
          )}
          {post.readingTime && (
            <div className="flex items-center gap-1">
              <Clock className="h-4 w-4" />
              {post.readingTime}åˆ†
            </div>
          )}
          <div className="flex items-center gap-1">
            <Eye className="h-4 w-4" />
            {post.viewCount}
          </div>
        </div>
      </div>

      {/* æœ¬æ–‡ */}
      <div className="prose max-w-none">
        <ReactMarkdown>{post.content}</ReactMarkdown>
      </div>

      {/* ã‚¿ã‚° */}
      {post.tags.length > 0 && (
        <div className="flex gap-2 mt-8">
          {post.tags.map(tag => (
            <span
              key={tag}
              className="px-3 py-1 bg-muted rounded-full text-sm"
            >
              {tag}
            </span>
          ))}
        </div>
      )}
    </div>
  )
}
```

---

## 4. Stripeæ±ºæ¸ˆè¨­å®šãƒšãƒ¼ã‚¸

### æ¦‚è¦

Adminãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§æ”¯æ‰•ã„æ–¹æ³•ã‚’ã€Œã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ï¼ˆStripeï¼‰ã€ã«è¨­å®šã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€ä¼šå“¡ã‚µã‚¤ãƒˆå´ã§Stripeã®åˆæœŸæ±ºæ¸ˆè¨­å®šã‚’è¡Œãˆã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

### ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

**Firestore `users` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã® `billingInfo` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰:**
```typescript
interface BillingInfo {
  plan: 'trial' | 'basic' | 'professional' | 'enterprise'
  monthlyFee: number
  currency: 'JPY' | 'USD'
  paymentMethod: 'credit_card' | 'bank_transfer' | 'invoice'
  nextBillingDate: string
  paymentStatus: 'paid' | 'pending' | 'overdue'
  // Stripeé–¢é€£
  stripeCustomerId?: string
  stripePaymentMethodId?: string
  stripeSetupIntentId?: string // ä¼šå“¡ã‚µã‚¤ãƒˆå´ã§è¨­å®šã™ã‚‹ãŸã‚
  requiresStripeSetup?: boolean // StripeåˆæœŸè¨­å®šãŒå¿…è¦ã‹ã©ã†ã‹
}
```

### å®Ÿè£…æ‰‹é †

#### 4-1. Stripe SDKã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
npm install @stripe/stripe-js @stripe/react-stripe-js
```

#### 4-2. Stripeè¨­å®šãƒšãƒ¼ã‚¸ã®ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«: `src/app/settings/payment/page.tsx`** ï¼ˆæ–°è¦ä½œæˆï¼‰

```typescript
'use client'

import React, { useState, useEffect } from 'react'
import { loadStripe } from '@stripe/stripe-js'
import {
  Elements,
  CardElement,
  useStripe,
  useElements
} from '@stripe/react-stripe-js'
import { useUserProfile } from '@/hooks/useUserProfile'
import { doc, updateDoc, getDoc } from 'firebase/firestore'
import { db } from '@/lib/firebase'

const stripePromise = loadStripe(process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY!)

function PaymentForm() {
  const stripe = useStripe()
  const elements = useElements()
  const { userProfile } = useUserProfile()
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [success, setSuccess] = useState(false)

  const handleSubmit = async (event: React.FormEvent) => {
    event.preventDefault()
    
    if (!stripe || !elements) {
      return
    }

    setLoading(true)
    setError(null)

    try {
      const cardElement = elements.getElement(CardElement)
      if (!cardElement) {
        throw new Error('Card element not found')
      }

      // 1. SetupIntentã‚’ä½œæˆï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§å®Ÿè£…ãŒå¿…è¦ï¼‰
      const response = await fetch('/api/stripe/create-setup-intent', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          userId: userProfile?.id,
        }),
      })

      if (!response.ok) {
        throw new Error('SetupIntentã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ')
      }

      const { clientSecret } = await response.json()

      // 2. Stripeã§æ”¯æ‰•ã„æ–¹æ³•ã‚’ç¢ºèª
      const { error: confirmError, setupIntent } = await stripe.confirmCardSetup(
        clientSecret,
        {
          payment_method: {
            card: cardElement,
            billing_details: {
              email: userProfile?.email,
              name: userProfile?.name,
            },
          },
        }
      )

      if (confirmError) {
        throw new Error(confirmError.message)
      }

      // 3. Firestoreã«æ”¯æ‰•ã„æ–¹æ³•IDã‚’ä¿å­˜
      if (userProfile?.id && setupIntent?.payment_method) {
        const userRef = doc(db, 'users', userProfile.id)
        await updateDoc(userRef, {
          'billingInfo.stripePaymentMethodId': setupIntent.payment_method,
          'billingInfo.stripeSetupIntentId': setupIntent.id,
          'billingInfo.requiresStripeSetup': false,
        })

        setSuccess(true)
        // 3ç§’å¾Œã«ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
        setTimeout(() => {
          window.location.reload()
        }, 3000)
      }
    } catch (err) {
      setError(err instanceof Error ? err.message : 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')
    } finally {
      setLoading(false)
    }
  }

  // Stripeè¨­å®šãŒå¿…è¦ãªå ´åˆã®ã¿è¡¨ç¤º
  if (!userProfile?.billingInfo?.requiresStripeSetup) {
    return (
      <div className="p-6 border rounded-lg">
        <h2 className="text-xl font-semibold mb-4">æ”¯æ‰•ã„æ–¹æ³•</h2>
        {userProfile?.billingInfo?.stripePaymentMethodId ? (
          <p className="text-green-600">âœ“ æ”¯æ‰•ã„æ–¹æ³•ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™</p>
        ) : (
          <p className="text-muted-foreground">æ”¯æ‰•ã„æ–¹æ³•ã®è¨­å®šã¯ä¸è¦ã§ã™</p>
        )}
      </div>
    )
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div className="p-6 border rounded-lg bg-yellow-50 border-yellow-200">
        <h2 className="text-xl font-semibold mb-4">Stripeæ±ºæ¸ˆè¨­å®š</h2>
        <p className="text-sm text-muted-foreground mb-4">
          ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆã®è¨­å®šã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
        </p>

        <div className="p-4 border rounded-lg bg-white">
          <CardElement
            options={{
              style: {
                base: {
                  fontSize: '16px',
                  color: '#424770',
                  '::placeholder': {
                    color: '#aab7c4',
                  },
                },
                invalid: {
                  color: '#9e2146',
                },
              },
            }}
          />
        </div>

        {error && (
          <div className="p-3 bg-red-50 border border-red-200 rounded text-red-800 text-sm">
            {error}
          </div>
        )}

        {success && (
          <div className="p-3 bg-green-50 border border-green-200 rounded text-green-800 text-sm">
            âœ“ æ”¯æ‰•ã„æ–¹æ³•ã®è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ
          </div>
        )}

        <button
          type="submit"
          disabled={!stripe || loading}
          className="w-full mt-4 px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {loading ? 'å‡¦ç†ä¸­...' : 'æ”¯æ‰•ã„æ–¹æ³•ã‚’è¨­å®š'}
        </button>
      </div>
    </form>
  )
}

export default function PaymentSettingsPage() {
  return (
    <div className="container mx-auto py-8 max-w-2xl">
      <h1 className="text-3xl font-bold mb-8">æ”¯æ‰•ã„è¨­å®š</h1>
      
      <Elements stripe={stripePromise}>
        <PaymentForm />
      </Elements>
    </div>
  )
}
```

#### 4-3. SetupIntentä½œæˆAPIã®å®Ÿè£…

**ãƒ•ã‚¡ã‚¤ãƒ«: `src/app/api/stripe/create-setup-intent/route.ts`** ï¼ˆæ–°è¦ä½œæˆï¼‰

```typescript
import { NextRequest, NextResponse } from 'next/server'
import Stripe from 'stripe'
import { requireAuthContext } from '@/lib/server/auth-context'

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2024-11-20.acacia',
})

export async function POST(request: NextRequest) {
  try {
    const authContext = await requireAuthContext(request, {
      requireContract: true,
    })

    const { userId } = await request.json()

    // Stripe Customerã‚’ä½œæˆï¼ˆã¾ã å­˜åœ¨ã—ãªã„å ´åˆï¼‰
    let customerId: string
    const userRef = doc(db, 'users', userId)
    const userDoc = await getDoc(userRef)
    const userData = userDoc.data()

    if (userData?.billingInfo?.stripeCustomerId) {
      customerId = userData.billingInfo.stripeCustomerId
    } else {
      const customer = await stripe.customers.create({
        email: authContext.email,
        metadata: {
          userId: userId,
        },
      })
      customerId = customer.id

      // Firestoreã«Customer IDã‚’ä¿å­˜
      await updateDoc(userRef, {
        'billingInfo.stripeCustomerId': customerId,
      })
    }

    // SetupIntentã‚’ä½œæˆ
    const setupIntent = await stripe.setupIntents.create({
      customer: customerId,
      payment_method_types: ['card'],
    })

    return NextResponse.json({
      clientSecret: setupIntent.client_secret,
    })
  } catch (error) {
    console.error('Error creating setup intent:', error)
    return NextResponse.json(
      { error: 'SetupIntentã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ' },
      { status: 500 }
    )
  }
}
```

#### 4-4. è¨­å®šãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«: `src/app/settings/page.tsx`**

```typescript
'use client'

import { useUserProfile } from '@/hooks/useUserProfile'
import Link from 'next/link'
import { AlertCircle } from 'lucide-react'

export default function SettingsPage() {
  const { userProfile } = useUserProfile()

  return (
    <div className="container mx-auto py-8">
      <h1 className="text-3xl font-bold mb-8">è¨­å®š</h1>
      
      {/* Stripeè¨­å®šãŒå¿…è¦ãªå ´åˆã®é€šçŸ¥ */}
      {userProfile?.billingInfo?.requiresStripeSetup && (
        <div className="p-4 bg-yellow-50 border border-yellow-200 rounded-lg mb-6">
          <div className="flex items-center gap-2 mb-2">
            <AlertCircle className="h-5 w-5 text-yellow-600" />
            <h2 className="font-semibold text-yellow-900">æ”¯æ‰•ã„æ–¹æ³•ã®è¨­å®šãŒå¿…è¦ã§ã™</h2>
          </div>
          <p className="text-sm text-yellow-800 mb-3">
            ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆã®è¨­å®šã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
          </p>
          <Link
            href="/settings/payment"
            className="inline-block px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700"
          >
            æ”¯æ‰•ã„æ–¹æ³•ã‚’è¨­å®š
          </Link>
        </div>
      )}

      {/* ãã®ä»–ã®è¨­å®šé …ç›® */}
      {/* ... */}
    </div>
  )
}
```

---

## 5. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

**ãƒ•ã‚¡ã‚¤ãƒ«: `.env.local`**

```bash
# Stripeè¨­å®š
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...
STRIPE_SECRET_KEY=sk_test_...

# Firebaseè¨­å®šï¼ˆæ—¢å­˜ã®ã‚‚ã®ã‚’ä½¿ç”¨ï¼‰
# ...
```

---

## 6. Firestoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®æ›´æ–°

**ãƒ•ã‚¡ã‚¤ãƒ«: `firestore.rules`**

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ... æ—¢å­˜ã®ãƒ«ãƒ¼ãƒ«

    // é€šçŸ¥ï¼ˆèª­ã¿å–ã‚Šã®ã¿ï¼‰
    match /notifications/{notificationId} {
      // å…¬é–‹ä¸­ã®é€šçŸ¥ã®ã¿èª­ã¿å–ã‚Šå¯èƒ½
      allow read: if isAuthenticated() && 
                       resource.data.status == 'published' &&
                       (resource.data.targetAudience == 'all' ||
                        resource.data.targetAudience == getUserPlanTier());
      // ç®¡ç†è€…ã®ã¿æ›¸ãè¾¼ã¿å¯èƒ½
      allow write: if isAuthenticated() && isAdminEmail(request.auth.token.email);
    }

    // ãƒ–ãƒ­ã‚°æŠ•ç¨¿ï¼ˆèª­ã¿å–ã‚Šã®ã¿ï¼‰
    match /blogPosts/{postId} {
      // å…¬é–‹ä¸­ã®æŠ•ç¨¿ã®ã¿èª­ã¿å–ã‚Šå¯èƒ½
      allow read: if isAuthenticated() && resource.data.status == 'published';
      // ç®¡ç†è€…ã®ã¿æ›¸ãè¾¼ã¿å¯èƒ½
      allow write: if isAuthenticated() && isAdminEmail(request.auth.token.email);
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã®ãƒ‡ãƒ¼ã‚¿æ›´æ–°ï¼ˆStripeé–¢é€£ï¼‰
    match /users/{userId} {
      // è‡ªåˆ†è‡ªèº«ã®billingInfoæ›´æ–°ã‚’è¨±å¯ï¼ˆStripeè¨­å®šç”¨ï¼‰
      allow update: if isAuthenticated() &&
                         request.auth.uid == userId &&
                         request.resource.data.diff(resource.data).affectedKeys()
                              .hasOnly(['billingInfo.stripePaymentMethodId',
                                       'billingInfo.stripeSetupIntentId',
                                       'billingInfo.requiresStripeSetup',
                                       'updatedAt']);
    }
  }
}
```

---

## 7. å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ãƒ—ãƒ©ãƒ³éšå±¤åˆ¥ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- [ ] `src/lib/plan-access.ts`ã®ä½œæˆ
- [ ] å„ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡å®Ÿè£…
- [ ] ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®æ¡ä»¶ä»˜ãè¡¨ç¤º
- [ ] APIãƒ«ãƒ¼ãƒˆã§ã®ãƒ—ãƒ©ãƒ³ãƒã‚§ãƒƒã‚¯

### é€šçŸ¥æ©Ÿèƒ½
- [ ] `src/types/notification.ts`ã®ä½œæˆ
- [ ] `src/lib/notifications.ts`ã®ä½œæˆ
- [ ] `src/components/notifications/notification-banner.tsx`ã®ä½œæˆ
- [ ] `src/app/notifications/page.tsx`ã®ä½œæˆ
- [ ] ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¸ã®é€šçŸ¥ãƒãƒŠãƒ¼è¿½åŠ 

### ãƒ–ãƒ­ã‚°/ã‚¬ã‚¤ãƒ‰æ©Ÿèƒ½
- [ ] `src/types/blog.ts`ã®ä½œæˆ
- [ ] `src/lib/blog.ts`ã®ä½œæˆ
- [ ] `src/app/guides/page.tsx`ã®ä½œæˆ
- [ ] `src/app/guides/[slug]/page.tsx`ã®ä½œæˆ
- [ ] Markdownãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

### Stripeæ±ºæ¸ˆè¨­å®š
- [ ] Stripe SDKã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- [ ] `src/app/settings/payment/page.tsx`ã®ä½œæˆ
- [ ] `src/app/api/stripe/create-setup-intent/route.ts`ã®ä½œæˆ
- [ ] ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
- [ ] è¨­å®šãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå®Ÿè£…

### Firestoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«
- [ ] `notifications`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ«ãƒ¼ãƒ«è¿½åŠ 
- [ ] `blogPosts`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ«ãƒ¼ãƒ«è¿½åŠ 
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®`billingInfo`æ›´æ–°ãƒ«ãƒ¼ãƒ«è¿½åŠ 

---

## 8. ãã®ä»–ã®æ³¨æ„äº‹é …

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
- é€šçŸ¥ã‚„ãƒ–ãƒ­ã‚°æŠ•ç¨¿ã¯é©åˆ‡ãª`limit`ã‚’è¨­å®šã—ã¦å–å¾—
- å¿…è¦ã«å¿œã˜ã¦ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…
- ç”»åƒã¯æœ€é©åŒ–ã•ã‚ŒãŸå½¢å¼ï¼ˆWebPãªã©ï¼‰ã‚’ä½¿ç”¨

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- Firestoreã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼ã‚’é©åˆ‡ã«å‡¦ç†
- Stripe APIã®ã‚¨ãƒ©ãƒ¼ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã«è¡¨ç¤º
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- Stripeã®ç§˜å¯†éµã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã®ã¿ä½¿ç”¨
- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®æ›´æ–°ã¯é©åˆ‡ãªèªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†
- XSSå¯¾ç­–ï¼ˆMarkdownãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰

---

## 9. å‚è€ƒè³‡æ–™

- [Stripe Setup Intents ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://stripe.com/docs/payments/setup-intents)
- [Firestore ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«](https://firebase.google.com/docs/firestore/security/get-started)
- [Next.js App Router](https://nextjs.org/docs/app)

---

## 10. æ›´æ–°å±¥æ­´

- **2025-01-18**: åˆç‰ˆä½œæˆ
  - ãƒ—ãƒ©ãƒ³éšå±¤åˆ¥ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®å®Ÿè£…æ‰‹é †ã‚’è¿½åŠ 
  - é€šçŸ¥æ©Ÿèƒ½ã®å®Ÿè£…æ‰‹é †ã‚’è¿½åŠ 
  - ãƒ–ãƒ­ã‚°/ã‚¬ã‚¤ãƒ‰æ©Ÿèƒ½ã®å®Ÿè£…æ‰‹é †ã‚’è¿½åŠ 
  - Stripeæ±ºæ¸ˆè¨­å®šãƒšãƒ¼ã‚¸ã®å®Ÿè£…æ‰‹é †ã‚’è¿½åŠ 

